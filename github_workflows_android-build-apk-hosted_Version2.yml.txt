name: Android APK build (hosted runner)

on:
  workflow_dispatch:
    inputs:
      generate_count:
        description: 'Number of generated classes to create (0 = none)'
        required: false
        default: '0'
  schedule:
    - cron: '0 6 * * 0' # weekly Sunday 06:00 UTC

permissions:
  contents: read

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    env:
      ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk
      ANDROID_HOME: ${{ github.workspace }}/android-sdk
      JAVA_TOOL_OPTIONS: -Xmx2048m
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install Android SDK commandline + NDK
        run: |
          set -e
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          cd "$ANDROID_SDK_ROOT"
          curl -sSfL "https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip" -o cmdline-tools.zip
          unzip -q cmdline-tools.zip -d cmdline-tools
          rm cmdline-tools.zip
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/bin:$PATH"
          yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --licenses || true
          sdkmanager --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-33" "build-tools;33.0.2" "ndk;25.2.9519653" || true

      - name: Optional: Run generator
        if: ${{ inputs.generate_count != '0' }}
        env:
          CONFIRM_GENERATE: yes
        run: |
          chmod +x ./generate_apk.sh || true
          ./generate_apk.sh --count "${{ inputs.generate_count }}" || true

      - name: Build (assembleDebug)
        run: |
          chmod +x ./gradlew || true
          ./gradlew assembleDebug --no-daemon --stacktrace || true

      - name: Collect APKs and artifacts
        run: |
          mkdir -p build_artifacts
          find . -type f -name "*.apk" -print0 | xargs -0 -I{} cp --parents {} build_artifacts/ 2>/dev/null || true
          ls -R build_artifacts || true

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-artifacts
          path: build_artifacts