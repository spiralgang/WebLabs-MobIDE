name: Repo-wide third-party dependency & vulnerability scan

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 5 * * 0' # weekly Sunday 05:00 UTC

permissions:
  contents: read
  actions: read

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare runner tools (trivy, grype)
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y jq curl unzip docker.io || true
          python3 -m pip install --upgrade pip || true
          python3 -m pip install pip-audit==3.* || true
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin || true
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sudo sh -s -- -b /usr/local/bin || true

      - name: Run manifest scan script (produces ./scans)
        run: |
          chmod +x .github/scripts/scan-manifests.sh || true
          .github/scripts/scan-manifests.sh || true

      - name: Upload scan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: repo-third-party-scans
          path: scans