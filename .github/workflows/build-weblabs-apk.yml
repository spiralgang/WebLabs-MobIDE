name: Build WebLabs APK

on:
  push:
    branches:
      - main
      - 'release/**'
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build-apk:
    name: Build APK
    runs-on: ubuntu-latest
    env:
      GRADLE_OPTS: -Dorg.gradle.jvmargs=-Xmx3g

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java (required for Gradle)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/gradle-wrapper.properties', '**/*.gradle*', '**/*.gradle.kts') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Make Gradlew Executable
        run: chmod +x gradlew

      - name: Install project dependencies
        run: ./gradlew --no-daemon dependencies || true

      - name: Assemble release APK
        run: ./gradlew assembleRelease --no-daemon

      - name: Collect APK artifact(s)
        if: always()
        run: |
          mkdir -p artifacts
          find app/build/outputs -type f -name "*.apk" -exec cp {} artifacts/ \; || true

      - name: Upload APK artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: WebLabs-MobIDE-apk
          path: artifacts/*.apk

      # FIXED: Indentation corrected here
      - name: Upload Release APK
        uses: actions/upload-artifact@v4 # UPDATED to v4
        with:
          name: WebLabs-MobIDE-Release-v${{ github.run_number }}
          path: app/build/outputs/apk/release/*.apk
          if-no-files-found: warn

      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: weblabs-build-logs
          path: |
            **/build/*.log
            app/build/outputs/**/*.log

      # FIXED: Indentation corrected here
      - name: Generate download links
        if: success()
        run: |
          echo "üéâ WebLabs-MobIDE APK Build Successful!"
          echo ""
          echo "üì± APK Downloads:"
          echo "- Debug APK: Available in Actions artifacts"
          echo "- Release APK: Available in Actions artifacts" 
          echo ""
          echo "üê≥ Features:"
          echo "- Ubuntu 24.04 ARM64 Docker environment"
          echo "- Code-Server web IDE at localhost:8080"  
          echo "- AI-powered development assistance"
          echo "- Mobile-optimized interface"
          echo "- Production-grade development tools"
          echo ""
          echo "üìã Installation:"
          echo "1. Download APK from GitHub Actions artifacts"
          echo "2. Enable 'Install from unknown sources' on Android"
          echo "3. Install APK on ARM64 Android 10+ device"
          echo "4. Launch WebLabs-MobIDE for Docker environment"

  create-release:
    name: Create GitHub Release
    needs: build-apk
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      # UPDATED: Switched to v4 to match the upload step (Critical Fix)
      - name: Download APK artifacts
        uses: actions/download-artifact@v4
        with:
          name: WebLabs-MobIDE-Release-v${{ github.run_number }}
          path: ./apks

      # UPDATED: Switched to softprops/action-gh-release (Modern Standard)
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v2.0.${{ github.run_number }}
          name: WebLabs-MobIDE v2.0.${{ github.run_number }} - Docker Ubuntu Environment
          files: ./apks/*.apk
          draft: false
          prerelease: false
          body: |
            üöÄ **WebLabs-MobIDE Docker Ubuntu Environment Release**
            
            A complete virtual Linux development environment running on Android devices!
            
            ## üê≥ What's New
            - **Ubuntu 24.04 ARM64** Docker environment with glibc
            - **Code-Server IDE** - Full VS Code experience at localhost:8080
            - **AI Integration** - Development assistance ready
            - **Mobile Optimized** - Touch-friendly cyberpunk interface
            
            ## üì± Features
            - Virtual Linux development environment on Android
            - Docker container management
            - Web-based VS Code IDE
            - AI-powered coding assistance
            - Project workspace management
            
            ## üéØ Requirements  
            - Android 10+ (API 29+)
            - ARM64/AArch64 device
            - 4GB+ RAM recommended
            
            ## üì• Installation
            1. Download the APK below
            2. Enable "Install from unknown sources" in Android settings
            3. Install APK on your ARM64 Android device
            4. Launch WebLabs-MobIDE
            5. Access Code-Server IDE at localhost:8080
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
